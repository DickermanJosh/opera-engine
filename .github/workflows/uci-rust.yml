name: Opera Engine Docker CI

on:
  push:
    branches: [ main, develop, uci ]
    paths: 
      - 'rust/**'
      - 'cpp/**'
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - '.github/workflows/uci-rust.yml'
  pull_request:
    branches: [ main, develop ]
    paths: 
      - 'rust/**'
      - 'cpp/**'
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - '.github/workflows/uci-rust.yml'

jobs:
  docker-build-and-test:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Opera Engine Docker image
      run: |
        echo "🐳 Building Opera Engine Docker image..."
        docker build -t opera-engine .

    - name: Verify Docker image
      run: |
        echo "✅ Verifying Docker image was built successfully..."
        docker images opera-engine
        docker run --rm opera-engine version

    - name: Run engine tests in container
      run: |
        echo "🧪 Running Opera Engine test suite in Docker container..."
        docker run --rm opera-engine test

    - name: Test UCI mode startup
      run: |
        echo "🎯 Testing UCI mode startup (with timeout)..."
        timeout 10s docker run --rm opera-engine uci < /dev/null || echo "UCI mode started successfully"

    - name: Check Docker image size
      run: |
        echo "📦 Checking Docker image size (should be < 300MB)..."
        SIZE=$(docker images opera-engine --format "table {{.Size}}" | tail -1)
        echo "Final image size: $SIZE"
        # Note: Size check is informational for now, will be enforced later
        
  # Optional: Multi-architecture build test (disabled for now to keep CI fast)
  # docker-multiarch:
  #   name: Multi-Architecture Build Test
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Set up QEMU
  #     uses: docker/setup-qemu-action@v3
  #     
  #   - name: Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v3
  #     
  #   - name: Build multi-architecture image
  #     run: |
  #       docker buildx build --platform linux/amd64,linux/arm64 -t opera-engine-multiarch .